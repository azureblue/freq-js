<html>
<head>
    <title>js-freq</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            border: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            position: absolute;
        }

        #ul, #ur, #lr {
            width: 50%;
            height: 50%;
        }

        #lr {
            width: 100%;
        }

        #lr {
            top: 50%;
        }

        #ur {
            left: 50%;
        }

    </style>
    <script src="cyclicBuffer.js"></script>
    <script src="average.js"></script>
    <script src="arrays.js"></script>
    <script src="music.js"></script>
    <script src="peeks.js"></script>
    <script src="noteFinder.js"></script>
    <script src="fft.js"></script>
    <script src="graph.js"></script>
    <script src="transform.js"></script>
    <script src="input.js"></script>
    <script src="window.js"></script>
    <script src="geom.js"></script>
    <script src="rolling_median.js"></script>
    <script src="analyser.js"></script>
    <script>
        const audioContext = new AudioContext();
        const sampleRate = audioContext.sampleRate;
        const sampleSize = 1024 * 4;
        const waveData = new Float32Array(sampleSize);

        const soundProcessor = audioContext.createScriptProcessor(sampleSize, 1, 1);
        console.log("sample rate: " + sampleRate);

        let waveGraph, logFftGraph, noteIndicator;
        let analyser;

        function start() {
            let waveScales = [new GraphScale(0, sampleSize, 1024, 0), new GraphScale(-1, 1, 0.2, 1)];
            let logFftScales = [new GraphScale(0, 4000, 100, 0), new GraphScale(-140, 0, 20, 0)];
            waveGraph = new Graph(document.getElementById('ul'), ...waveScales);
            logFftGraph = new Graph(document.getElementById('lr'), ...logFftScales);
            noteIndicator = new NoteIndicator(document.getElementById('ur'));
            analyser = new Analyser(sampleSize, sampleRate, waveGraph, logFftGraph, noteIndicator);
            navigator.mediaDevices.getUserMedia({audio: true, video: false})
                .then(handleStream, () => console.error("couldn't open audio input"))
                .catch(ex => console.error(ex));
        }

        function handleStream(stream) {
            const sc = audioContext.createMediaStreamSource(stream);

            soundProcessor.onaudioprocess = function (audioProcessEvent) {
                audioProcessEvent.inputBuffer.copyFromChannel(waveData, 0);
                analyser.update(waveData);
            };

            sc.connect(soundProcessor);
            soundProcessor.connect(audioContext.destination);
        }

    </script>
</head>
<body onload="start();">
<canvas id="ul"></canvas>
<!-- <canvas id="ll"></canvas> -->
<canvas id="ur"></canvas>
<canvas id="lr"></canvas>
</body>
</html>
