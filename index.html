<html>
<head>
    <title>js-freq</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            border: 0px;
            width: 100%;
            height: 100%;
            margin: 0px;
            position: absolute;
        }
        #ul,#ur,#ll,#lr {width: 50%; height: 50%;}
        #ll,#lr {top: 50%;}
        #ur,#lr {left: 50%;}

    </style>
    <script src="arrays.js"></script>
    <script src="music.js"></script>
    <script src="window.js"></script>
    <script src="fft.js"></script>
    <script src="graph.js"></script>
    <script src="geom.js"></script>
    <script>
        const params = createParamMap();
        const audioContext = new AudioContext();
        const sampleRate = audioContext.sampleRate;
        const sampleSize = parseInt(params['samplesize']) || 1024 * 4;
        const fft = new FFT(sampleSize);
        const wave = new Float32Array(sampleSize);
        const fftMagnitude = [new Float32Array(sampleSize), new Float32Array(sampleSize)];
        const wavexs = new Float32Array(sampleSize);
        const wavefftxs = new Float32Array(sampleSize / 2);

        for (let i = 0; i < sampleSize; i++)
            wavexs[i] = i;
        for (let i = 0; i < sampleSize / 2; i++)
            wavefftxs[i] = i * sampleRate / sampleSize;

        let currentMag = 0;
        const soundProcessor = audioContext.createScriptProcessor(sampleSize, 1, 1);
        const hw = new GaussianWindow(sampleSize, 0.5);
        console.log("sample rate: " + sampleRate);
        let waveGraph, fftGraph, logFftGraph;

        function binToFreq(i) {
            return i * sampleRate / sampleSize;
        }

        function createParamMap() {
            var map = {};
            var params = window.location.search.substr(1).split("&");
            params.forEach(par => {
                var kv = par.split("=");
                map[kv[0]] = kv[1];
            });
            return map;
        }

        function start() {
            let waveScales = [new GraphScale(0, sampleSize, 1024, 0), new GraphScale(-1, 1, 0.2, 1)];
            let fftScales = [new GraphScale(0, 2000, 200, 0), new GraphScale(0, 1, 0.1, 1)];
            let logFftScales = [new GraphScale(0, 2000, 200, 0), new GraphScale(-150, 0, 10, 0)];
            waveGraph = new Graph(document.getElementById('ul'), ...waveScales);
            fftGraph = new Graph(document.getElementById('ll'), ...fftScales);
            logFftGraph = new Graph(document.getElementById('lr'), ...logFftScales);
            noteIdnicator = new NoteIndicator(document.getElementById('ur'));
            navigator.mediaDevices.getUserMedia({audio: true, video: false})
                .then(handleStream, () => console.error("couldn't open audio input"))
                .catch(ex => console.error(ex));
        }

        function handleStream(stream) {
            const sc = audioContext.createMediaStreamSource(stream);
            const on = audioContext.createOscillator();
            on.frequency.value = 440;

            soundProcessor.onaudioprocess = function (apEvent) {
                apEvent.inputBuffer.copyFromChannel(wave, 0);
                //wave.fill(1.0);
                hw.apply(wave, wave);
                fft.fft(wave);
                fft.magnitude(fftMagnitude[currentMag++ % 2]);
                redraw2();
            };
            sc.connect(soundProcessor);
//                on.connect(soundProcessor);


            soundProcessor.connect(audioContext.destination);
            on.start();
        }

        const mag = new Float32Array(sampleSize / 2);
        const logMag = new Float32Array(sampleSize / 2);
        const smoothMag = new Float32Array(sampleSize / 2);
        const movAvg = new Float32Array(sampleSize / 2);

        let windowSum = hw.sum / 2;
        let lastFoundNoteRes;

        const ma = new MovingAverage(1);
        const mt = new ComparatorTransform(0);
        const peekFinder = new PeekFinder();
        const peekInterpolator = new QuadraticPeekInterpolator();
        const notes = [];
        for (let note = Note.parse('C1'), limit = Note.parse('C7'); note.midiNumber < limit.midiNumber; note = note.note(1))
            notes.push(note);
        const noteFinder = new NoteFinder(notes);

        function redraw2() {
            waveGraph.drawScales();
            waveGraph.plotData(wavexs, wave);
            fftGraph.drawScales();
            logFftGraph.drawScales();
            for (var i = 0; i < sampleSize / 2; i++) {
                mag[i] = (fftMagnitude[0][i] + fftMagnitude[1][i]) / 2;
                logMag[i] = 20 * Math.log10(mag[i] / windowSum);
            }
            logFftGraph.plotData(wavefftxs, logMag);
            ma.spread = 1;
            ma.apply(mag, smoothMag);
            transformInPlace(smoothMag, v => Math.sqrt(v * 2) / 4);
            ma.spread = sampleSize / 64;
            ma.apply(smoothMag, movAvg);
            transformInPlace(movAvg, v => v + 0.005);
            fftGraph.plotData(wavefftxs, movAvg);
            mt.apply(smoothMag, movAvg, smoothMag);
            fftGraph.plotData(wavefftxs, smoothMag);
            peeks = [];
            peekFinder.forEachPeek(smoothMag, peek => {
                    if (smoothMag[peek] > 0) {
                        let ip = peekInterpolator.interpolatePeek(logMag[peek - 1], logMag[peek], logMag[peek + 1]);
                        let peekFreq = binToFreq(peek + ip);
                        fftGraph.plotVerticalLine(peekFreq, peekFreq.toFixed(1));
                        peeks.push(peekFreq);
                    }
                }
            );
            var res = noteFinder.findNote(peeks);
            if (!res.note)
                res = lastFoundNoteRes;
            if (res) {
                lastFoundNoteRes = res;
                noteIdnicator.drawNote(res.note, res.avgCentDiff)
            }
        }


    </script>
</head>
<body onload="start();">
<canvas id="ul"></canvas>
<canvas id="ll"></canvas>
<canvas id="ur"></canvas>
<canvas id="lr"></canvas>
</body>
</html>
